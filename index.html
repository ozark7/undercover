<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>🎭 Undercover</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        push,
        update,
        onValue,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCob3LEUMLwlCXAiGzheIuGmYQhArpHQ_k",
        authDomain: "undercover-37256.firebaseapp.com",
        projectId: "undercover-37256",
        storageBucket: "undercover-37256.firebasestorage.app",
        messagingSenderId: "756599146063",
        appId: "1:756599146063:web:0e9de4a385b2f8c11fcc3a",
        measurementId: "G-EW0ZL3GNTK",
        databaseURL: "https://undercover-37256-default-rtdb.firebaseio.com",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let gameId = localStorage.getItem("gameId") || null;
      let playerName = localStorage.getItem("playerName") || "";

      const playerInput = document.getElementById("username");
      const createBtn = document.getElementById("createRoom");
      const joinBtn = document.getElementById("joinRoom");
      const enterBtn = document.getElementById("enterGame");
      const playersList = document.getElementById("playersList");
      const statusText = document.getElementById("statusText");

      // 🔹 Crear sala
      async function createGame() {
        const newGameRef = push(ref(db, "games"));
        gameId = newGameRef.key;
        localStorage.setItem("gameId", gameId);
        await set(newGameRef, {
          state: "waiting",
          players: {},
          host: null,
        });
        alert(`🎮 Sala creada con ID: ${gameId}`);
        statusText.textContent = `Sala creada (#${gameId})`;
        listenGame();
      }

      // 🔹 Unirse a sala existente
      async function joinGame() {
        const id = prompt("🔑 ID de la sala:");
        if (!id) return;
        const snap = await get(ref(db, "games/" + id));
        if (!snap.exists()) return alert("❌ No existe esa sala");
        gameId = id;
        localStorage.setItem("gameId", gameId);
        statusText.textContent = `Unido a la sala (#${gameId})`;
        listenGame();
      }

      // 🔹 Agregar jugador a la sala
      async function addPlayer() {
        const name = playerInput.value.trim();
        if (!name) return alert("⚠️ Escribe un nombre");
        if (!gameId) return alert("🎮 Primero crea o únete a una sala");

        playerName = name;
        localStorage.setItem("playerName", name);

        await update(ref(db, `games/${gameId}/players/${name}`), {
          name,
          alive: true,
        });

        const snap = await get(ref(db, `games/${gameId}/host`));
        if (!snap.exists()) {
          await set(ref(db, `games/${gameId}/host`), name);
          alert(`👑 Eres el host de la sala #${gameId}`);
        }

        playerInput.value = "";
      }

      // 🔹 Escuchar cambios del juego
      function listenGame() {
        const gameRef = ref(db, `games/${gameId}`);
        onValue(gameRef, (snap) => {
          const data = snap.val();
          if (!data) return;
          const players = data.players || {};
          renderPlayers(players);
        });
      }

      // 🔹 Mostrar jugadores conectados
      function renderPlayers(players) {
        const list = Object.values(players)
          .map((p) => `<li class="text-fuchsia-300">👤 ${p.name}</li>`)
          .join("");
        playersList.innerHTML = list || "<li class='text-gray-500'>Sin jugadores aún...</li>";
      }

      // Eventos de botones
      createBtn.addEventListener("click", createGame);
      joinBtn.addEventListener("click", joinGame);
      enterBtn.addEventListener("click", addPlayer);

      // Reentrar si ya había sesión guardada
      if (gameId) listenGame();
    </script>
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-black via-purple-950 to-gray-900 text-white flex flex-col items-center justify-center font-sans"
  >
    <!-- NAV -->
    <header
      class="w-full bg-gray-900/60 backdrop-blur-lg shadow-md p-4 fixed top-0"
    >
      <nav class="flex justify-center space-x-8 text-purple-300 font-semibold">
        <a href="#" class="hover:text-fuchsia-400 transition">🏠 Home</a>
        <a href="#" class="hover:text-fuchsia-400 transition">ℹ️ About</a>
        <a href="#" class="hover:text-fuchsia-400 transition">📩 Contact</a>
      </nav>
    </header>

    <!-- MAIN -->
    <main class="flex flex-col items-center mt-32 space-y-8 text-center">
      <h1
        class="text-4xl md:text-5xl font-extrabold text-fuchsia-400 drop-shadow-lg"
      >
        🎭 UNDERCOVER
      </h1>
      <p class="text-lg text-gray-300 max-w-md" id="statusText">
        Esperando acción...
      </p>

      <div class="flex gap-4">
        <button
          id="createRoom"
          class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg text-lg font-bold transition transform hover:scale-105"
        >
          🟢 Crear sala
        </button>
        <button
          id="joinRoom"
          class="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg text-lg font-bold transition transform hover:scale-105"
        >
          🔵 Unirse a sala
        </button>
      </div>

      <form class="w-full max-w-sm space-y-3">
        <input
          id="username"
          type="text"
          placeholder="✍️ Tu nombre"
          class="w-full p-3 rounded-lg bg-gray-800 text-white placeholder-gray-400 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-fuchsia-500"
        />
        <button
          id="enterGame"
          type="button"
          class="w-full bg-gradient-to-r from-purple-600 to-fuchsia-600 p-3 rounded-lg font-semibold text-lg hover:from-fuchsia-600 hover:to-purple-600 transition transform hover:scale-105"
        >
          🚀 Entrar a partida
        </button>
      </form>

      <!-- Lista de jugadores -->
      <ul id="playersList" class="space-y-1 text-left"></ul>
    </main>

    <footer class="mt-16 text-gray-500 text-sm">Hecho con 💜 por OCK</footer>
  </body>
</html>
